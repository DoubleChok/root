'use strict';var THREE,pool=function(){var b=[],d=null,c={};return pool={get:function(a){return c[a]},getResult:function(){return c},load:function(a,c){"string"==typeof a||a instanceof String?b.push(a):b=b.concat(a);d=c||function(){};this.loadOne()},next:function(){b.shift();0===b.length?d(c):this.loadOne()},loadOne:function(){var a=b[0],c=a.substring(a.lastIndexOf("/")+1,a.lastIndexOf(".")),e=a.substring(a.lastIndexOf(".")+1);if("jpg"===e||"png"===e)this.loadImage(a,c);else this[e+"_load"](a,c)},
loadImage:function(a,b){var e=new Image;e.onload=function(){c[b]=e;this.next()}.bind(this);e.src=a},sea_load:function(a,b){var e=new THREE.SEA3D;e.onComplete=function(a){a=e.meshes.length;for(var d,k=[],n={};a--;)d=e.meshes[a],n[d.name]=d,k.push(d.name);c[b]=n;this.next()}.bind(this);e.load(a)},json_load:function(a,b){var e=new XMLHttpRequest;e.overrideMimeType("application/json");e.onload=function(){c[b]=JSON.parse(e.responseText);this.next()}.bind(this);e.open("GET",a,!0);e.send(null)},glsl_load:function(a,
b){var e=new XMLHttpRequest;e.onload=function(){c[b]=e.responseText;this.next()}.bind(this);e.open("GET",a,!0);e.send(null)},cube_load:function(a,b){function c(){if(a.length){var d=a.length-1,h=new Image;h.onload=function(){f[d]=h;c()};h.src=a.pop()}else pool.cube_load_end(b,f)}var d=a.substring(0,a.lastIndexOf("."))+"/";a=[d+"posx.png",d+"negx.png",d+"posy.png",d+"negy.png",d+"posz.png",d+"negz.png"];var f=[];c()},cube_load_end:function(a,b){var e=new THREE.CubeTexture(b);e.format=THREE.RGBFormat;
e.needsUpdate=!0;c[a]=e;this.next()}}}();var view=function(){var b=!1,d=!1,c=window.innerWidth,a=window.innerHeight,m=1,e,h,f,k,n,r,g,p,q,l,u,t,s,w,x=0,y,z,v,C=[],A=[],D,E,B,F,G="undefined"!==typeof Uint8Array?Uint8Array:Array;return view={init:function(){D=new THREE.Color(3355443);E=new THREE.Color(16711680);m=c/a;e=document.createElement("div");e.style.cssText="position:absolute; top:0; left:0; width:100%; height:100%; border:none;";document.body.appendChild(e);h=document.createElement("canvas");h.style.cssText="position:absolute; top:0px; left:0px;";
e.appendChild(h);f=new THREE.WebGLRenderer({canvas:h,precision:"mediump",antialias:!1,premultipliedAlpha:!1});f.setPixelRatio(window.devicePixelRatio);f.setSize(c,a);f.setClearColor(3355443,1);f.getContext();k=new THREE.Scene;p=new THREE.Group;k.add(p);g=new THREE.Group;k.add(g);q=new THREE.Group;k.add(q);n=new THREE.PerspectiveCamera(45,m,0.1,1E3);this.initCameraTop();this.initLight();this.initMaterial();window.addEventListener("resize",view.resize,!1);this.render()},snapShoot:function(){view.materialSwitch(!0);
f.setSize(512,512);f.setClearColor(E);f.render(k,v,y,!0);f.readRenderTargetPixels(y,0,0,512,512,z);map.drawLand(z);d=!0},initCameraTop:function(){l=new THREE.Group;y=new THREE.WebGLRenderTarget(512,512,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat,type:THREE.UNSIGNED_BYTE});z=new G(1048576);v=new THREE.OrthographicCamera(-16,16,16,-16,1,8);v.position.set(0,5,0);v.lookAt(new THREE.Vector3);u=new THREE.CameraHelper(v);u.visible=!1;l.add(v);k.add(l);k.add(u)},initLight:function(){t=
new THREE.AmbientLight(2631716);s=new THREE.DirectionalLight(16777215,1);s.position.set(2,10,6).multiplyScalar(10);s.lookAt(new THREE.Vector3(0,0,0));w=new THREE.PointLight(8306926,1,200);w.position.set(-2,-10,-6).multiplyScalar(10);k.add(t);k.add(s);k.add(w)},initMaterial:function(){r=new THREE.MeshLambertMaterial({color:14540253});B=new THREE.ShaderMaterial({uniforms:{decal:{type:"f",value:0},deep:{type:"f",value:10},rgb:{type:"f",value:0.003921}},vertexShader:"uniform float deep;\nuniform float decal;\nuniform float rgb;\nvarying vec3 c;\nvoid main() {\nfloat d = ( position.y + decal ) * deep * rgb;\nc = vec3( d, d, d );\nif( position.y < 0.0 ) c = vec3( 0., 0., -d );\ngl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",
fragmentShader:"varying vec3 c;\nvoid main() { gl_FragColor = vec4( c, 1.0 ); }"});F=new THREE.ShaderMaterial({uniforms:{},vertexShader:"void main() {\ngl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",fragmentShader:"void main() { gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 ); }"})},addUpdate:function(a){C.push(a)},add:function(a,b){b=b||{};var c=b.pos||[0,0,0],e=b.scale||1;a.material=b.material||r;a.userData.mat=a.material;a.userData.type=b.type||0;a.userData.level=void 0!==
b.level?b.level:-1;1!==e&&a.scale.multiplyScalar(e);a.position.fromArray(c);2===a.userData.type&&(a.visible=!1);1===a.userData.type||3===a.userData.type?p.add(a):g.add(a);A.push(a)},findLevel:function(){for(var a=A.length,b,c;a--;)b=A[a],c=b.userData.level,-1!==c&&(b.visible=c===x?!0:!1)},setLevel:function(a){a!==x&&(x=a,b=!0)},checkNewLevel:function(){return b?(b=!1,!0):!1},resize:function(){c=window.innerWidth;a=window.innerHeight;m=c/a;f.setSize(c,a);n.aspect=m;n.updateProjectionMatrix()},testPosition:function(a,
b){l.position.copy(a);map.moveCamera(a);map.testHit()},materialSwitch:function(a){a=a||!1;for(var b=A.length,c,e;b--;)c=A[b],e=c.userData.type,a?(u.visible=!1,0===e?c.visible=!1:1===e?c.material=B:2===e?(c.visible=!0,c.material=B):3===e?c.visible=!1:4===e&&(c.material=F),view.findLevel()):0===e?c.visible=!0:2===e?c.visible=!1:3===e?c.visible=!0:c.material=c.userData.mat},render:function(b){requestAnimationFrame(view.render);for(b=C.length;b--;)C[b](0);d&&(view.materialSwitch(!1),f.setSize(c,a),f.setClearColor(D));
f.render(k,n)},moveCamera:function(a){q.position.copy(a)},getScene:function(){return k},getPlayerGroup:function(){return q},getGround:function(){return p},getWall:function(){return g},getRenderer:function(){return f},getCamera:function(){return n},getMeshs:function(){return A},setDeep:function(a){B.uniforms.deep.value=a},setDecal:function(a){B.uniforms.decal.value=a}}}();var map=function(){var b={f:0,b:0,r:0,l:0},d,c,a,m,e,h,f,k,n,r,g,p,q,l,u=0,t=[22,23,24,25,36,37,42,43,66,82,97,113,129,145,162,178,77,93,110,126,142,158,173,189,212,213,218,219,230,231,232,233],s=[87,88,102,103,104,105,117,118,121,122,133,134,137,138,150,151,152,153,168,167];return map={init:function(){d=document.createElement("div");d.style.cssText="position:absolute; top:10px; right:10px; width:66px; height:66px; border:1px solid #74818b;";document.body.appendChild(d);c=document.createElement("canvas");
c.width=c.height=16;a=c.getContext("2d");a.getImageData(0,0,16,16);m=document.createElement("canvas");m.width=m.height=16;e=m.getContext("2d");h=e.getImageData(0,0,16,16);this.smooth(a);this.smooth(e);for(var b=s.length,l;b--;)l=4*s[b],h.data[l+0]=255,h.data[l+1]=255,h.data[l+2]=0,h.data[l+3]=255;c.style.cssText="position:absolute; top:24px; left:24px; -moz-transform: scale(4, 4); -webkit-transform: scale(4, 4); -o-transform: scale(4, 4); transform: scale(4, 4);";m.style.cssText="position:absolute; top:24px; left:24px; -moz-transform: scale(4, 4); -webkit-transform: scale(4, 4); -o-transform: scale(4, 4); transform: scale(4, 4);";
d.appendChild(c);d.appendChild(m);this.init3d()},initTestCanvas:function(){r=document.createElement("canvas");r.width=512;r.height=512;g=r.getContext("2d");r.style.cssText="position:absolute; bottom:-118px; left:-118px;  -moz-transform: scale(0.5, 0.5); -webkit-transform: scale(0.5, 0.5); -o-transform: scale(0.5, 0.5); transform: scale(0.5, 0.5);";document.body.appendChild(r)},drawTest:function(){g.clearRect(0,0,512,512);g.save();g.setTransform(1,0,0,1,0,0);g.translate(l.x+8,l.y+8);g.rotate(u);g.translate(-8,
-8);g.beginPath();g.lineWidth="1";g.strokeStyle="yellow";g.rect(0,0,16,16);g.rect(7,8,2,8);g.stroke();g.restore()},init3d:function(){f=document.createElement("canvas");f.width=512;f.height=512;k=f.getContext("2d");n=k.getImageData(0,0,512,512);f.style.cssText="position:absolute; bottom:-118px; left:-118px; opacity:0.25; -moz-transform: scale(0.5, 0.5); -webkit-transform: scale(0.5, 0.5); -o-transform: scale(0.5, 0.5); transform: scale(0.5, 0.5);";document.body.appendChild(f);map.initTestCanvas();
p=new THREE.Vector2(-1E3,-1E3);q=new THREE.Vector2(0,0);l=new THREE.Vector2(0,0)},testDistance:function(){var a=p.x-q.x,b=p.y-q.y,a=Math.sqrt(a*a+b*b),b=view.checkNewLevel();if(14<a||b)p.copy(q),view.snapShoot()},moveCamera:function(a){q.set(a.x,a.z);map.testDistance()},rotateCamera:function(a){u=a;map.drawTest()},drawLand:function(a){for(var b=n.data,c=1048576;c--;)b[c]=a[c];k.putImageData(n,0,0)},render:function(){l.x=248+16*(q.x-p.x);l.y=248-16*(q.y-p.y);a.fillStyle="#00FF00";a.fillRect(0,0,16,
16);a.save();a.setTransform(1,0,0,-1,0,16);a.translate(8,8);a.rotate(-u);a.drawImage(f,l.x,l.y,16,16,-8,-8,16,16);a.restore();map.drawTest()},testHit:function(){map.render();var c=a.getImageData(0,0,16,16).data;b={f:0,b:0,r:0,l:0};for(var l=h.data,d,m,v,f=t.length,g;f--;)d=Math.floor(0.125*f),g=4*t[f],m=c[g],v=c[g+2],255===m&&0===v?(0===d&&b.f++,1===d&&b.l++,2===d&&b.r++,3===d&&b.b++,l[g]=255,l[g+1]=255,l[g+3]=255):l[g+3]=0;e.putImageData(h,0,0)},smooth:function(a,b){b=b||!1;a.imageSmoothingEnabled=
b;a.mozImageSmoothingEnabled=b;a.webkitImageSmoothingEnabled=b;a.msImageSmoothingEnabled=b},getPY:function(){return 0},getHit:function(){return b}}}(),deepShader={};var user=function(){var b=new Float32Array(20),d;user={init:function(){d=new c(b);document.addEventListener("keydown",user.keydown,!1);document.addEventListener("keyup",user.keyup,!1);view.addUpdate(user.update)},update:function(){d.update();d.ready&&d.getValue()},keydown:function(a){a=a||window.event;switch(a.keyCode){case 65:case 81:b[0]=-1;break;case 68:b[0]=1;break;case 87:case 90:b[1]=-1;break;case 83:b[1]=1;break;case 37:b[2]=-1;break;case 39:b[2]=1;break;case 38:b[3]=-1;break;case 40:b[3]=
1;break;case 17:case 67:b[5]=1;break;case 69:b[5]=1;break;case 32:b[4]=1;break;case 16:b[7]=1}d.reset()},keyup:function(a){a=a||window.event;switch(a.keyCode){case 65:case 81:b[0]=0>b[0]?0:b[0];break;case 68:b[0]=0<b[0]?0:b[0];break;case 87:case 90:b[1]=0>b[1]?0:b[1];break;case 83:b[1]=0<b[1]?0:b[1];break;case 37:b[2]=0>b[2]?0:b[2];break;case 39:b[2]=0<b[2]?0:b[2];break;case 38:b[3]=0>b[3]?0:b[3];break;case 40:b[3]=0<b[3]?0:b[3];break;case 17:case 67:b[5]=0;break;case 69:b[5]=0;break;case 32:b[4]=
0;break;case 16:b[7]=0}},getKey:function(){return b}};var c=function(a){this.values=[];this.key=a;this.ready=0;this.current=-1};c.prototype={update:function(){this.current=-1;var a,b,c,d,f,k,n=this.fix,r=navigator.getGamepads();for(a=0;a<r.length;a++)if(k=r[a])if(this.current=a,c=k.axes.length,d=k.buttons.length){this.values[a]||(this.values[a]=[]);for(b=0;b<c;b++)f=n(k.axes[b],0.08),0===this.ready&&0!==f&&(this.ready=1),this.values[a][b]=f;for(b=0;b<d;b++)f=n(k.buttons[b].value),0===this.ready&&
0!==f&&(this.ready=1),this.values[a][c+b]=f}else this.values[a]&&(this.values[a]=null)},getValue:function(){var a=this.current;if(!(0>a))for(var b=19,c;b--;)c=this.values[a][b],0===this.ready&&0!==c&&(this.ready=1),this.key[b]=c},reset:function(){this.ready=0},fix:function(a,b){var c=Number(a.toString().substring(0,5));b&&c<b&&c>-b&&(c=0);return c}};return user}();var player=function(){var b,d,c,a,m,e,h,f={},k=0,n=null,r=null,g,p,q;return player={init:function(l,u){q=user.getKey();h=new THREE.Raycaster;h.ray.direction.set(0,-1,0);b=view.getPlayerGroup();new THREE.Vector3;new THREE.Vector3;new THREE.Vector3;e=new THREE.Vector3;m=new THREE.Vector3;c=new THREE.Vector3;a=new THREE.Vector3;var t=new THREE.Mesh(new THREE.CylinderBufferGeometry(0.5,0.5,2,8,1),new THREE.MeshBasicMaterial({color:0,wireframe:!0}));t.geometry.applyMatrix((new THREE.Matrix4).makeRotationY(0.125*
Math.PI));t.position.y=1;d=l;d.scale.set(0.023,0.023,0.023);d.position.set(0,0.9,0);d.rotation.y=Math.PI;d.material=new THREE.MeshLambertMaterial({color:14540032,skinning:!0});for(var t=k=d.animations.length,s;t--;)s=d.animations[t].name,f[s]=0,"idle"===s&&(f[s]=1),d.playw(s,f[s]);b.add(d);p=new THREE.SphereBufferGeometry(0.1);g=new THREE.MeshLambertMaterial({color:65280});r=new THREE.Mesh(p,g);n=new THREE.Group;b.add(n);view.getScene().add(r);view.addUpdate(player.move)},setAnimation:function(){var a=
5*c.x,b=5*c.z,e=0<a?-1:1,f=0<b?1:-1,a=Math.abs(a),b=Math.abs(b);d.setWeight("idle",1-0.5*(a+b));d.setWeight("walk",a);d.setWeight("step_right",b);d.setClipTimeScale("walk",e);d.setClipTimeScale("step_right",f);THREE.SEA3D.AnimationHandler.update(0.025)},raytest:function(){var a=view.getGround();h.ray.origin.copy(e);h.ray.origin.y+=2;a=h.intersectObject(a,!0);0<a.length&&0<a[0].face.normal.y&&(a=a[0].distance,e.y=100>a?e.y+(2-a):e.y-(a-2),m.y=e.y)},shoot:function(){},move:function(){b.position.copy(e);
cam.update();r.position.copy(cam.rayTest());c.z+=0.017*-q[0];c.x+=0.017*q[1];c.z=0.2<c.z?0.2:c.z;c.z=-0.2>c.z?-0.2:c.z;c.x=0.2<c.x?0.2:c.x;c.x=-0.2>c.x?-0.2:c.x;q[0]||(c.z=0.017<c.z?c.z-0.017:-0.017>c.z?c.z+0.017:0);q[1]||(c.x=0.017<c.x?c.x-0.017:-0.017>c.x?c.x+0.017:0);a.y=cam.getAzimut();map.rotateCamera(-a.y);player.setAnimation();var d=!0;0===c.z&&0===c.x&&(d=!1);if(d){a.x=Math.sin(a.y)*c.x+Math.cos(a.y)*c.z;a.z=Math.cos(a.y)*c.x-Math.sin(a.y)*c.z;m.x=e.x-a.x;m.z=e.z+a.z;2<m.y?view.setLevel(1):
view.setLevel(0);view.testPosition(m);player.raytest();var d=map.getHit(),f=Math.floor((57.29577951308232*-a.y+225)/90);4===f&&(f=0);var g=e.x-m.x,h=e.z-m.z,k=0,n=0;switch(f){case 0:0>h&&2<d.f&&(n=1);0<h&&2<d.b&&(n=1);0>g&&2<d.l&&(k=1);0<g&&2<d.r&&(k=1);break;case 1:0>h&&2<d.r&&(n=1);0<h&&2<d.l&&(n=1);0>g&&2<d.f&&(k=1);0<g&&2<d.b&&(k=1);break;case 2:0>h&&2<d.b&&(n=1);0<h&&2<d.f&&(n=1);0>g&&2<d.r&&(k=1);0<g&&2<d.l&&(k=1);break;case 3:0>h&&2<d.l&&(n=1),0<h&&2<d.r&&(n=1),0>g&&2<d.b&&(k=1),0<g&&2<d.f&&
(k=1)}k||(e.x=m.x);n||(e.z=m.z)}}}}();var cam=function(){var b=!1,d=!1,c=!1,a,m,e,h,f,k,n,r,g=1.570796326794896,p=1.570796326794896,q=0,l=4,u=0,t=1.6,s,w,x=0,y,z;return cam={init:function(){t=1.6;new THREE.Vector3(0,t,0);a=view.getPlayerGroup();m=view.getCamera();h=new THREE.Group;e=new THREE.Group;e.position.set(0,0,-1);h.add(m);h.add(e);a.add(h);f=view.getMeshs();y=new THREE.Raycaster;z=y.ray;k=new THREE.Vector3;n=new THREE.Vector3;r=new THREE.Vector3;a.matrixAutoUpdate=!1;new THREE.Vector3(0,0,0);s=new THREE.Vector2;w=new THREE.Vector2;
h.position.set(0.5,t,0);document.addEventListener("contextmenu",function(a){a.preventDefault()},!1);document.addEventListener("mouseup",cam.up,!1);document.addEventListener("mousedown",cam.down,!1);document.addEventListener("mousemove",cam.move,!1);document.addEventListener("mousewheel",cam.wheel,!1);this.orbit()},changeCallback:function(a){b=document.pointerLockElement===document.body||document.mozPointerLockElement===document.body||document.webkitPointerLockElement===document.body?!0:!1},orbit:function(){g=
Math.max(1E-6,Math.min(3.141591653589793,g));h.rotation.x=g-1.570796326794896;d?(q=cam.unwrap(p+1.570796326794896),h.rotation.x*=-1):(q=cam.unwrap(p-1.570796326794896),m.position.z=l,h.position.x=0.1*l);a.rotation.y=-q},update:function(){a.matrix.compose(a.position,a.quaternion,a.scale);a.matrixWorld.copy(a.matrix);h.updateMatrixWorld(!0);n.setFromMatrixPosition(h.matrixWorld);k.setFromMatrixPosition(e.matrixWorld)},rayTest:function(){z.origin.copy(n);z.direction.copy(k).sub(n).normalize();var a=
y.intersectObjects(f,!0);0<a.length&&r.copy(a[0].point);return r},down:function(a){c=!0;x=a.which;b?s.set(0,0):s.set(a.clientX,a.clientY);w.set(p,g);hub.precis(3===x?!0:!1)},up:function(a){c=!1;x=0},mode:function(a){if(a!==d){if(d=a)m.position.set(0,0,0),h.position.x=0;p=cam.unwrap(p+3.141592653589793);g=-1*(g-1.570796326794896)+1.570796326794896}},move:function(a){if(b){u=d?1:-1;var e=a.movementY||a.mozMovementY||a.webkitMovementY||0;p+=0.016*(a.movementX||a.mozMovementX||a.webkitMovementX||0);g+=
0.016*e*u;cam.orbit()}else u=d?-1:1,c&&1===x&&(p=0.016*-(s.x-a.clientX)+w.x,g=0.016*(s.y-a.clientY)*u+w.y,cam.orbit())},wheel:function(a){var b=0;a.deltaY?b=a.deltaY:a.wheelDeltaY?b=-a.wheelDeltaY:a.wheelDelta?b=-a.wheelDelta:a.detail&&(b=a.detail);l=0>b?0.9*l:l/0.9;l=5<l?5:l;l=0.5>l?0.5:l;0.5===l?cam.mode(!0):cam.mode(!1);cam.orbit()},unwrap:function(a){a%=6.283185307179586;3.141592653589793<a&&(a-=6.283185307179586);-3.141592653589793>a&&(a+=6.283185307179586);return a},getAzimut:function(){return q},
getAxis:function(){return h},getCamera:function(){return m},getMarker:function(){return r}}}();var hub=function(){var b,d;return hub={init:function(){b=document.createElementNS("http://www.w3.org/2000/svg","svg");b.style.cssText="position:absolute; top:50%; left:50%; margin:-64px -64px; width:128px; height:128px; ";document.body.appendChild(b);d=document.createElementNS("http://www.w3.org/2000/svg","path");d.setAttributeNS(null,"id","pp");d.setAttributeNS(null,"fill","none");d.setAttributeNS(null,"stroke","#00FF00");d.setAttributeNS(null,"stroke-width","2");d.setAttributeNS(null,"stroke-linecap",
"butt");d.setAttributeNS(null,"stroke-linejoin","miter");hub.changePath(40);b.appendChild(d)},changePath:function(b){var a=b+10,m=64-b+64,e=64-(b+10)+64;d.setAttributeNS(null,"d","M "+b+" 64 L "+a+" 64 M "+m+" 64 L "+e+" 64 M 64 "+b+" L 64 "+a+" M 64 "+m+" L 64 "+e)},move:function(b){b?hub.changePath(30):hub.changePath(40)},precis:function(b){b?hub.changePath(50):hub.changePath(40)}}}();
