<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Rondo</title>
<meta name="Description" content="" />
<meta name="Keywords"  content="" />
<style>
* { margin: 0; padding: 0; border: 0; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: -moz-none; -o-user-select: none; user-select: none; }
body { 
    font-family: "Lucida Console", Monaco, monospace;
    font-size: 11px; 
    color:#fff;
    background: #000000; 
    overflow:hidden; 
}

.debug { font-family:"Lucida Console", Monaco, monospace; position:absolute; font-size:16px;  top:10px; left:10px; text-align:left; pointer-events:none; width:300px;}

</style>


<script src="js/three.min.js"></script>
<script src="js/sea3d.min.js"></script>

<script src="js/uil.min.js"></script>
<script src="js/pool.js"></script>
<script src="js/ShaderShadow.js"></script>
<script src="js/geomerty/Tubex.js"></script>
<script src="js/Model.js"></script>
<script src="js/Head.js"></script>
<script src="js/controls/OrbitControls.js"></script>
<script src="js/BVHLoader.js"></script>

<script src="js/tween.min.js"></script>

<script src="js/shaders/CopyShader.js"></script>
<script src="js/postprocessing/EffectComposer.js"></script>
<script src="js/postprocessing/SSAARenderPass.js"></script>
<script src="js/postprocessing/RenderPass.js"></script>
<script src="js/postprocessing/ShaderPass.js"></script>

</head>
<body>

<script>

    var isFull = false;

    var camera, scene, renderer, controler, clock;

    var man, woman;

    var bvhLoader;

    var gui, gui2, g_animation = null, g_animation2 = null;

    var mx=0, my=0;

    var vx=0, vy=0;
    
    
    

    var torad = 0.0174532925199432957;

    init();
    animate();

    function init() {

        vx = window.innerWidth;
        vy = window.innerHeight;

        //clock = new THREE.Clock();

        camera = new THREE.PerspectiveCamera( 70, vx / vy, 1, 1000 );
        camera.position.z = 100;

        scene = new THREE.Scene();

        /*var texture = new THREE.TextureLoader().load( 'assets/textures/rondo.jpg' );

        var geometry = new THREE.BoxBufferGeometry( 200, 200, 200 );
        var material = new THREE.MeshBasicMaterial( { map: texture } );

        mesh = new THREE.Mesh( geometry, material );
        scene.add( mesh );*/

        renderer = new THREE.WebGLRenderer({ antialias: false });
        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize(vx, vy );
        document.body.appendChild( renderer.domElement );

        renderer.setClearColor( 0xffd400, 1 );
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.soft = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.shadowMap.renderReverseSided = false;

        controler = new THREE.OrbitControls( camera, renderer.domElement );


        var ambient = new THREE.AmbientLight( 0x333333 );
        scene.add( ambient );


        var light = new THREE.DirectionalLight( 0xffffff, 0.3 );
        light.position.set(5,50,40);
        light.lookAt( new THREE.Vector3( 0,0,0) );
        scene.add( light );
        light.castShadow = true;
        var d = 200;
        var distance = 100;
        var camShadow = new THREE.OrthographicCamera( d, -d, d, -d,  50, 300 );
        light.shadow = new THREE.LightShadow( camShadow );
        light.shadow.mapSize.width = 1024;
        light.shadow.mapSize.height = 1024;
        //light.shadow.bias = 0.0001;

        // extra plane shadow
        var planemat = new THREE.ShaderMaterial( THREE.ShaderShadow );
        var plane = new THREE.Mesh( new THREE.PlaneBufferGeometry( d*2, d*2, 1, 1 ), planemat );
        plane.geometry.applyMatrix( new THREE.Matrix4().makeRotationX(-Math.PI*0.5));
        plane.position.y = -62;
        plane.castShadow = false;
        plane.receiveShadow = true;
        scene.add( plane );

        var point = new THREE.PointLight( 0xffffff, 1 );
        point.position.set(-5,10,80);
        scene.add( point );








        //

        window.addEventListener( 'resize', onWindowResize, false );
        document.addEventListener( 'mousemove', onMouse, false );


        pool.load( ['assets/textures/medium.jpg','assets/textures/rondo_m.jpg', 'assets/textures/rondo_w.jpg', 'assets/models/rondo.sea', 'assets/models/head.sea'], onLoadComplete );

        

    }

    function onLoadComplete( p ) {

        // textures

        var txt = {};

        txt['env'] = new THREE.Texture( p.medium );
        txt['env'].mapping = THREE.SphericalReflectionMapping;
        txt['env'].needsUpdate = true;

        txt['man'] = new THREE.Texture( p.rondo_m );
        txt['man'].flipY = false;
        txt['man'].needsUpdate = true;

        txt['wom'] = new THREE.Texture( p.rondo_w );
        txt['wom'].flipY = false;
        txt['wom'].needsUpdate = true;

        // sea meshs

        var meshs = pool.meshByName ( 'rondo' );
        var meshs2 = pool.meshByName ( 'head' );


        // morph hack

        this.correctMorph('eye', meshs2 );
        this.correctMorph('eyec', meshs2 );
        this.correctMorph('eyebrow', meshs2 );

        this.correctMorph('mouth', meshs2 );
        this.correctMorph('lips', meshs2 );
        this.correctMorph('tooth', meshs2 );

        //

        man = new V.Model( 'man', meshs, txt, new THREE.Vector3( 40, -65, 0 ), meshs2 );
        woman = new V.Model( 'wom', meshs, txt, new THREE.Vector3( -40, -65, 0 ), meshs2 );


        initGUI();

        loadAnimation('assets/bvh/action.z');

    }

    function correctMorph( name, meshs ){

        var morph = ['_open', '_close', '_sad', '_happy' ];

        for( var i=0; i < morph.length; i++ ) {

            meshs[name].geometry.morphAttributes.position[i].array = meshs[name+morph[i]].geometry.attributes.position.array;
            meshs[name].geometry.morphAttributes.normal[i].array = meshs[name+morph[i]].geometry.attributes.normal.array;

        }

    };

    function loadAnimation( file ){

        bvhLoader = new THREE.BVHLoader();

        var xml = new XMLHttpRequest();
        xml.responseType = 'arraybuffer';

        xml.onload = function () {

            var name = file.substring( file.lastIndexOf('/')+1,file.lastIndexOf('.') );
            parseBvhAnimation( name, bvhLoader.parse( SEA3D.File.LZMAUncompress( xml.response ) ) );

        }

        xml.open( 'GET', file, true );
        xml.send( null );

    }

    function parseBvhAnimation( name, result ){

        result.clip.name = name;
        var bvhClip = result.clip;
        var seq = null;

        if(name === 'base' ){
            seq = [

                ['idle', 5, 25],

                ['walk', 325, 355],
                ['walk_side_r', 360, 390],
                ['walk_diag_r', 395, 425],
                ['walk_side_l', 430, 460],
                ['walk_diag_l', 465, 495],

                ['run', 500, 530 ],
                ['run_side_r', 535, 565 ],
                ['run_diag_r', 570, 600 ],
                ['run_side_l', 605, 635 ],
                ['run_diag_l', 640, 670 ],

                ['crouch', 675, 705],
                ['crouch_side_r', 710, 740 ],
                ['crouch_diag_r', 745, 775 ],
                ['crouch_side_l', 780, 810 ],
                ['crouch_diag_l', 815, 845 ],

            ]
        }

        var decale = 50;
        if(name === 'base')decale = 40

        


        bvhLoader.applyToModel( man.mesh, bvhClip, man.poseMatrix, seq, decale );
        bvhLoader.applyToModel( woman.mesh, bvhClip, woman.poseMatrix, seq, decale );

        //

        if(name === 'action') loadAnimation('assets/bvh/story.z');
        
        if(name === 'story') loadAnimation('assets/bvh/base.z');
        
        if(name === 'base') {

            addAnimator( man.mesh );
            addAnimator( woman.mesh );

            man.play('idle');
            woman.play('idle');

            man.addToScene( scene );
            woman.addToScene( scene );

            isFull = true;

        }

    }

    function initGUI(){

        gui = new UIL.Gui( { width:200, bg:'rgba(23,23,23,0.5)' } );
        gui2 = new UIL.Gui( { css:'top:0px; left:10px;', width:200, bg:'rgba(23,23,23,0.5)' } );

        gui.add('fps',  { res:70 });

        gui.add('Bool', { name:'Debug' } ).onChange( function(b){man.setDebug(b)} );
        gui2.add('Bool', { name:'Debug' } ).onChange( function(b){woman.setDebug(b)} );

        gui.add('button', { name:'Material', height:20, value:[1, 2, 3] }).onChange( function(n){man.setMaterial(n)} );
        gui2.add('button', { name:'Material', height:20, value:[1, 2, 3] }).onChange( function(n){woman.setMaterial(n)} );

        gui.add('slide',  { name:'speed', min:-3, max:3, value:1, precision:2, stype:1 }).onChange( function(v){ man.setSpeed( v ) } );
        gui2.add('slide',  { name:'speed', min:-3, max:3, value:1, precision:2, stype:1 }).onChange( function(v){ woman.setSpeed( v ) } );

        var m1 = gui.add('group', { name:'MORPH' });
        var m2 = gui2.add('group', { name:'MORPH' });

        m1.add('slide',  { name:'close eye', min:0, max:1, value:0, precision:2 }).onChange( function(v){ man.head.morphEye('close', v ) } );
        m1.add('slide',  { name:'close', min:0, max:1, value:1, precision:2 }).onChange( function(v){ man.head.morphMouth('close', v ) } );
        m1.add('slide',  { name:'open', min:0, max:1, value:0, precision:2 }).onChange( function(v){ man.head.morph('open', v ) } );
        m1.add('slide',  { name:'happy', min:0, max:1, value:0, precision:2 }).onChange( function(v){ man.head.morph('happy', v ) } );
        m1.add('slide',  { name:'sad', min:0, max:1, value:0, precision:2 }).onChange( function(v){ man.head.morph('sad', v ) } );

        m2.add('slide',  { name:'close eye', min:0, max:1, value:0, precision:2 }).onChange( function(v){ woman.head.morphEye('close', v ) } );
        m2.add('slide',  { name:'close', min:0, max:1, value:1, precision:2 }).onChange( function(v){ woman.head.morphMouth('close', v ) } );
        m2.add('slide',  { name:'open', min:0, max:1, value:0, precision:2 }).onChange( function(v){ woman.head.morph('open', v ) } );
        m2.add('slide',  { name:'happy', min:0, max:1, value:0, precision:2 }).onChange( function(v){ woman.head.morph('happy', v ) } );
        m2.add('slide',  { name:'sad', min:0, max:1, value:0, precision:2 }).onChange( function(v){ woman.head.morph('sad', v ) } );

        m1.open();
        m2.open();

    };

    function addAnimator( model ){

        if(model.name ==='man'){
            if( g_animation === null ) g_animation = gui.add('group', { name:'ANIMATIONS' });
            var name;
            for(var i = 0; i < model.animations.length; i++){
                name = model.animations[i].name;
                g_animation.add('button', { name:name, p:0 }).onChange( function(n){  model.stopAll(); model.play(n);  } );

            }

            //g_animation.open();
        } else {

            if( g_animation2 === null ) g_animation2 = gui2.add('group', { name:'ANIMATIONS' });
            var name;
            for(var i = 0; i<model.animations.length; i++){
                name = model.animations[i].name;
                g_animation2.add('button', { name:name, p:0 }).onChange( function(n){  model.stopAll(); model.play(n);  } );

            }

            //g_animation2.open();

        }

        

    }

    function onMouse( e ) {
        mx = ( e.clientX/ vx ) * 2 - 1;
        my = ( e.clientY / vy ) * 2 - 1;

        //console.log(mx, my)
    }


    function onWindowResize() {

        vx = window.innerWidth;
        vy = window.innerHeight;

        camera.aspect = vx / vy;
        camera.updateProjectionMatrix();
        renderer.setSize( vx, vy );

    }

    function animate() {

        requestAnimationFrame( animate );

        //var delta = clock.getDelta();

        if( isFull ){

            man.update(mx,my);
            woman.update(mx,my);

            TWEEN.update();

            THREE.SEA3D.AnimationHandler.update( 0.007 );

        }
        
        renderer.render( scene, camera );

    }




</script>
</body>
</html>
