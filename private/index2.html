<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Rondo</title>
<meta name="Description" content="" />
<meta name="Keywords"  content="" />
<style>
* { margin: 0; padding: 0; border: 0; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: -moz-none; -o-user-select: none; user-select: none; }
body { 
    font-family: "Lucida Console", Monaco, monospace;
    font-size: 11px; 
    color:#fff;
    background: #000000; 
    overflow:hidden; 
}

.debug { font-family:"Lucida Console", Monaco, monospace; position:absolute; font-size:16px;  top:10px; left:10px; text-align:left; pointer-events:none; width:300px;}
.yo { font-family:"Lucida Console", Monaco, monospace; position:absolute; font-size:16px;  top:10px; left:10px; text-align:left; cursor:pointer; pointer-events:auto; width:100px;}

</style>


<script src="js/three.min.js"></script>
<script src="js/sea3d.min.js"></script>
<script src="js/uil.min.js"></script>
<script src="js/pool.js"></script>
<script src="js/ShaderShadow.js"></script>
<script src="js/controls/OrbitControls.js"></script>

</head>
<body>

<script>

var time = 0.01;

    var camera, scene, renderer, controler;
    
    var meshs = {};
    var mat = {};
    var txt = {};

    var models = [];

    var torad = 0.0174532925199432957;

    init();
    animate();

    function init() {

        camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 1, 1000 );
        camera.position.z = 100;

        scene = new THREE.Scene();

        //var light = new THREE.DirectionalLight( 0xffffff, 1.2 );
        //light.position.set(60,70,80);
        //light.lookAt( new THREE.Vector3( 0,0,0) );


        var light = new THREE.DirectionalLight( 0xffffff, 1.3 );
                    //light.position.copy(centroid).add( new THREE.Vector3(-1,2,0.5).multiplyScalar( radius ) );
                    //light.lookAt( centroid );
        light.position.set(60,70,80);
        light.lookAt( new THREE.Vector3( 0,0,0) );
        scene.add( light );



        scene.add(light);
        light.castShadow = true;
        var d = 200;
        var distance = 100;
        var camShadow = new THREE.OrthographicCamera( d, -d, d, -d,  50, 300 );
        light.shadow = new THREE.LightShadow( camShadow );

        light.shadow.mapSize.width = 1024;
        light.shadow.mapSize.height = 1024;
        light.shadow.bias = 0.0001;

                        // extra plane shadow
                        var planemat = new THREE.ShaderMaterial( THREE.ShaderShadow );
                        var plane = new THREE.Mesh( new THREE.PlaneBufferGeometry( d*2, d*2, 1, 1 ), planemat );
                        plane.geometry.applyMatrix(new THREE.Matrix4().makeRotationX(-Math.PI*0.5));
                        plane.position.y = -50
                        plane.castShadow = false;
                        plane.receiveShadow = true;
                        scene.add( plane );

        var ambient = new THREE.AmbientLight( 0x909090 );
        scene.add( ambient );

        renderer = new THREE.WebGLRenderer();
        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize( window.innerWidth, window.innerHeight );
        document.body.appendChild( renderer.domElement );

        renderer.setClearColor( 0xffd400, 1 );
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.soft = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.shadowMap.renderReverseSided = false;


        controler = new THREE.OrbitControls( camera, renderer.domElement );

        //

        window.addEventListener( 'resize', onWindowResize, false );

        var dd = document.createElement('div');
        dd.className = 'yo';
        document.body.appendChild(dd);
        dd.innerHTML = 'DANCE';

        dd.addEventListener( 'click', dancing, false );

        

            

        


        pool.load( ['assets/textures/medium.jpg', 'assets/textures/rondo_m.jpg', 'assets/textures/rondo_w.jpg', 'assets/models/rondoid.sea'], onLoadComplete );

    }

    function dancing () {

        time = 0.017;

        models[0].play(2);
        models[1].play(2);

    }

    function onLoadComplete( p ) {

        txt['env'] = new THREE.Texture( p.medium );
        txt['env'].mapping = THREE.SphericalReflectionMapping;
        txt['env'].needsUpdate = true;

        txt['man'] = new THREE.Texture( p.rondo_m );
        txt['man'].flipY = false;
        txt['man'].needsUpdate = true;

        txt['wom'] = new THREE.Texture( p.rondo_w );
        txt['wom'].flipY = false;
        txt['wom'].needsUpdate = true;

        mat['skin0'] = new THREE.MeshStandardMaterial({ map:txt.man, skinning:true, envMap:txt.env, metalness:0.7 });
        mat['base0'] = new THREE.MeshStandardMaterial({ map:txt.man, envMap:txt.env, metalness:0.7 });

        mat['skin1'] = new THREE.MeshStandardMaterial({ map:txt.wom, skinning:true, envMap:txt.env, metalness:0.7 });
        mat['base1'] = new THREE.MeshStandardMaterial({ map:txt.wom, envMap:txt.env, metalness:0.7 });

        var m = pool.meshByName ( 'rondoid' );

        meshs['body'] = m.body;
        meshs['head'] = m.head;
        meshs['corps'] = m.corps;
        meshs['extra_man'] = m.extra_man;
        meshs['extra_wom'] = m.extra_wom;

        //meshs.extra_wom.visible = false;

        /*meshs.body.material = mat.skin;
        meshs.head.material = mat.base;
        meshs.corps.material = mat.base;
        meshs.extra_man.material = mat.base;
        meshs.extra_wom.material = mat.base;*/

        addModel('man', new THREE.Vector3(40, -20, 0 ) );
        addModel('wom', new THREE.Vector3(-40, -20, 0 ) );

    }

    function addModel ( type, pos ) {

        var m = meshs.body.clone();

        var b = m.skeleton.bones;

        var a0 = meshs.corps.clone();
        a0.rotation.set(180*torad,180*torad, 0*torad );

        var a1 = meshs.head.clone();
        a1.rotation.set(180*torad,180*torad, 0*torad );

        var a2 = type === 'man' ? meshs.extra_man.clone() : meshs.extra_wom.clone()

        a1.add(a2);

        m.material = type === 'man' ? mat.skin0 : mat.skin1;
        a0.material = type === 'man' ? mat.base0 : mat.base1;
        a1.material = type === 'man' ? mat.base0 : mat.base1;
        a2.material = type === 'man' ? mat.base0 : mat.base1;

        b[0].add(a0);
        b[6].add(a1);

        if(type === 'man') m.play(0);
        else m.play(1);
        m.position.copy( pos );

        scene.add( m )

        models.push(m);




    }

    function onWindowResize() {

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize( window.innerWidth, window.innerHeight );

    }

    function animate() {

        requestAnimationFrame( animate );
        THREE.SEA3D.AnimationHandler.update( time );
        renderer.render( scene, camera );

    }


</script>
</body>
</html>
