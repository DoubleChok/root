'use strict';var THREE,Fabrik=Fabrik||{};Fabrik.torad=0.017453292519943295;Fabrik.todeg=57.29577951308232;Fabrik.MIN_ANGLE_DEGS=0;Fabrik.MAX_ANGLE_DEGS=180;Fabrik.MAX_VALUE=Infinity;Fabrik.START=0;Fabrik.END=1;Fabrik.J_BALL=0;Fabrik.J_GLOBAL_HINGE=1;Fabrik.J_LOCAL_HINGE=2;Fabrik.BB_NONE=0;Fabrik.BB_GLOBAL_ROTOR=1;Fabrik.BB_LOCAL_ROTOR=2;Fabrik.BB_GLOBAL_HINGE=3;Fabrik.BB_LOCAL_HINGE=4;Fabrik.lerp=function(a,b,c){return a+(b-a)*c};Fabrik.randRange=function(a,b){return Fabrik.lerp(a,b,Math.random())};
Fabrik.randRangeInt=function(a,b,c){return 1*Fabrik.lerp(a,b,Math.random()).toFixed(c||0)};Fabrik.nearEquals=function(a,b,c){return Math.abs(a-b)<=c?!0:!1};Fabrik.sign=function(a){return 0<=a?1:-1};Fabrik.radtodeg=function(a){return a*Fabrik.todeg};Fabrik.degtorad=function(a){return a*Fabrik.torad};Fabrik.cot=function(a){return 1/Math.tan(a)};Fabrik.V3=function(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0};Fabrik.V3.prototype={};Fabrik.V3.prototype.constructor=Fabrik.V3;Fabrik.V3.prototype.lengthIsApproximately=function(a){return Math.abs(this.length()-1)<a?!0:!1};Fabrik.V3.prototype.normalize=function(){var a=this.length();0<a&&(this.x/=a,this.y/=a,this.z/=a);return this};Fabrik.V3.prototype.clone=function(){return new this.constructor(this.x,this.y,this.z)};Fabrik.V3.prototype.set=function(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0;return this};
Fabrik.V3.prototype.normalised=function(){return(new Fabrik.V3(this.x,this.y,this.z)).normalize()};Fabrik.V3.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};Fabrik.V3.prototype.plus=function(a){return new Fabrik.V3(this.x+a.x,this.y+a.y,this.z+a.z)};Fabrik.V3.prototype.minus=function(a){return new Fabrik.V3(this.x-a.x,this.y-a.y,this.z-a.z)};Fabrik.V3.prototype.divideBy=function(a){return new Fabrik.V3(this.x/a,this.y/a,this.z/a)};
Fabrik.V3.prototype.times=function(a){return new Fabrik.V3(this.x*a,this.y*a,this.z*a)};Fabrik.V3.prototype.randomise=function(a,b){this.x=Fabrik.randRange(a,b);this.y=Fabrik.randRange(a,b);this.z=Fabrik.randRange(a,b)};Fabrik.V3.prototype.projectOnPlane=function(a){if(0<a.length()){var b=this.normalised(),c=a.normalised();return b.minus(c.times(Fabrik.dotProduct(b,a))).normalize()}};
Fabrik.V3.prototype.cross=function(a){return new Fabrik.V3(this.y*a.z-this.z*a.y,this.z*a.x-this.x*a.z,this.x*a.y-this.y*a.x)};Fabrik.V3.prototype.negate=function(){this.x=-this.x;this.y=-this.y;this.z=-this.z;return this};Fabrik.V3.prototype.negated=function(){return new this.constructor(-this.x,-this.y,-this.z)};Fabrik.V3.prototype.copy=function(a){this.x=a.x;this.y=a.y;this.z=a.z;return this};
Fabrik.V3.prototype.approximatelyEquals=function(a,b){if(!(0>b)){var c=Math.abs(this.x-a.x),d=Math.abs(this.y-a.y),e=Math.abs(this.z-a.z);return c<b&&d<b&&e<b}};Fabrik.perpendicular=function(a,b){return Fabrik.nearEquals(Fabrik.dotProduct(a,b),0,0.01)?!0:!1};Fabrik.scalarProduct=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z};Fabrik.dotProduct=function(a,b){var c=a.normalised(),d=b.normalised();return c.x*d.x+c.y*d.y+c.z*d.z};
Fabrik.crossProduct=function(a,b){return new Fabrik.V3(a.y*b.z-a.z*b.y,a.z*b.x-a.x*b.z,a.x*b.y-a.y*b.x)};Fabrik.genPerpendicularVectorQuick=function(a){return(0.99>Math.abs(a.y)?new Fabrik.V3(-a.z,0,a.x):new Fabrik.V3(0,a.z,-a.y)).normalize()};Fabrik.genPerpendicularVectorHM=function(a){var b=Fabrik.absV3(a);return b.x<=b.y&&b.x<=b.z?(new Fabrik.V3(0,-a.z,a.y)).normalize():b.y<=b.x&&b.y<=b.z?(new Fabrik.V3(-a.z,0,a.x)).normalize():(new Fabrik.V3(-a.y,a.x,0)).normalize()};
Fabrik.genPerpendicularVectorFrisvad=function(a){if(-0.9999999>a.z)return new Fabrik.V3(0,-1,0);var b=1/(1+a.z);return(new Fabrik.V3(1-a.x*a.x*b,-a.x*a.y*b,-a.x)).normalize()};Fabrik.getUvBetween=function(a,b){return(new Fabrik.V3).copy(b.minus(a)).normalize()};Fabrik.timesV3=function(a,b){a.x*=b;a.y*=b;a.z*=b};Fabrik.absV3=function(a){return new Fabrik.V3(0>a.x?-a.x:a.x,0>a.y?-a.y:a.y,0>a.z?-a.z:a.z)};Fabrik.getAngleBetweenRads=function(a,b){return Math.acos(Fabrik.dotProduct(a,b))};
Fabrik.getAngleBetweenDegs=function(a,b){return Fabrik.getAngleBetweenRads(a,b)*Fabrik.todeg};Fabrik.getSignedAngleBetweenDegs=function(a,b,c){var d=Fabrik.getAngleBetweenDegs(a,b);a=Fabrik.sign(Fabrik.dotProduct(Fabrik.crossProduct(a,b),c));return d*a};Fabrik.getDirectionUV=function(a,b){return b.minus(a).normalize()};Fabrik.rotateAboutAxisDegs=function(a,b,c){return Fabrik.rotateAboutAxisRads(a,b*Fabrik.torad,c)};
Fabrik.rotateAboutAxisRads=function(a,b,c){var d=new Fabrik.M3,e=Math.sin(b);b=Math.cos(b);var f=1-b,h=c.x*c.y*f,g=c.x*c.z*f,k=c.y*c.z*f;d.m00=c.x*c.x*f+b;d.m01=h+c.z*e;d.m02=g-c.y*e;d.m10=h-c.z*e;d.m11=c.y*c.y*f+b;d.m12=k+c.x*e;d.m20=g+c.y*e;d.m21=k-c.x*e;d.m22=c.z*c.z*f+b;return d.timesV3(a)};Fabrik.rotateXDegs=function(a,b){return Fabrik.rotateXRads(a,b*Fabrik.torad)};Fabrik.rotateYDegs=function(a,b){return Fabrik.rotateYRads(a,b*Fabrik.torad)};
Fabrik.rotateZDegs=function(a,b){return Fabrik.rotateZRads(a,b*Fabrik.torad)};Fabrik.rotateXRads=function(a,b){var c=Math.cos(b),d=Math.sin(b);return new Fabrik.V3(a.x,a.y*c-a.z*d,a.y*d+a.z*c)};Fabrik.rotateYRads=function(a,b){var c=Math.cos(b),d=Math.sin(b);return new Fabrik.V3(a.z*d+a.x*c,a.y,a.z*c-a.x*d)};Fabrik.rotateZRads=function(a,b){var c=Math.cos(b),d=Math.sin(b);return new Fabrik.V3(a.x*c-a.y*d,a.x*d+a.y*c,a.z)};
Fabrik.getAngleLimitedUnitVectorDegs=function(a,b,c){return Fabrik.getAngleBetweenDegs(b,a)>c?(a=Fabrik.crossProduct(b.normalised(),a.normalised()).normalize(),Fabrik.rotateAboutAxisDegs(b,c,a).normalize()):a.normalised()};Fabrik.withinManhattanDistance=function(a,b,c){return Math.abs(b.x-a.x)>c||Math.abs(b.y-a.y)>c||Math.abs(b.z-a.z)>c?!1:!0};Fabrik.manhattanDistanceBetween=function(a,b){return Math.abs(b.x-a.x)+Math.abs(b.x-a.x)+Math.abs(b.x-a.x)};
Fabrik.distanceBetween=function(a,b){var c=b.x-a.x,d=b.y-a.y,e=b.z-a.z;return Math.sqrt(c*c+d*d+e*e)};Fabrik.M3=function(a,b,c,d,e,f,h,g,k){this.m00=a||1;this.m01=b||0;this.m02=c||0;this.m10=d||0;this.m11=e||1;this.m12=f||0;this.m20=h||0;this.m21=g||0;this.m22=k||1};Fabrik.M3.prototype={};Fabrik.M3.prototype.constructor=Fabrik.M3;Fabrik.M3.prototype.setV3=function(a,b,c){this.m00=a.x;this.m01=a.y;this.m02=a.z;this.m10=b.x;this.m11=b.y;this.m12=b.z;this.m20=c.x;this.m21=c.y;this.m22=c.z;return this};
Fabrik.M3.prototype.transpose=function(a){return new Fabrik.M3(a.m00,a.m10,a.m20,a.m01,a.m11,a.m21,a.m02,a.m12,a.m22)};Fabrik.M3.prototype.zero=function(){this.m00=this.m01=this.m02=this.m10=this.m11=this.m12=this.m20=this.m21=this.m22=0;return this};Fabrik.M3.prototype.setIdentity=function(){this.m00=this.m11=this.m22=1;this.m01=this.m02=this.m10=this.m12=this.m20=this.m21=0;return this};
Fabrik.M3.prototype.determinant=function(){return this.m20*this.m01*this.m12-this.m20*this.m02*this.m11-this.m10*this.m01*this.m22+this.m10*this.m02*this.m21+this.m00*this.m11*this.m22-this.m00*this.m12*this.m21};
Fabrik.M3.prototype.timesM3=function(a){var b=new Fabrik.M3;b.m00=this.m00*a.m00+this.m10*a.m01+this.m20*a.m02;b.m01=this.m01*a.m00+this.m11*a.m01+this.m21*a.m02;b.m02=this.m02*a.m00+this.m12*a.m01+this.m22*a.m02;b.m10=this.m00*a.m10+this.m10*a.m11+this.m20*a.m12;b.m11=this.m01*a.m10+this.m11*a.m11+this.m21*a.m12;b.m12=this.m02*a.m10+this.m12*a.m11+this.m22*a.m12;b.m20=this.m00*a.m20+this.m10*a.m21+this.m20*a.m22;b.m21=this.m01*a.m20+this.m11*a.m21+this.m21*a.m22;b.m22=this.m02*a.m20+this.m12*a.m21+
this.m22*a.m22;return b};Fabrik.M3.prototype.timesV3=function(a){return new Fabrik.V3(this.m00*a.x+this.m10*a.y+this.m20*a.z,this.m01*a.x+this.m11*a.y+this.m21*a.z,this.m02*a.x+this.m12*a.y+this.m22*a.z)};
Fabrik.M3.prototype.isOrthogonal=function(){var a=Fabrik.dotProduct(this.getXBasis(),this.getYBasis()),b=Fabrik.dotProduct(this.getXBasis(),this.getZBasis()),c=Fabrik.dotProduct(this.getYBasis(),this.getZBasis());return Fabrik.nearEquals(a,0,0.01)&&Fabrik.nearEquals(b,0,0.01)&&Fabrik.nearEquals(c,0,0.01)?!0:!1};
Fabrik.M3.prototype.inverse=function(a){var b=a.determinant(),c=new Fabrik.M3;c.m00=(a.m11*a.m22-a.m12*a.m21)/b;c.m01=-(a.m01*a.m22-a.m02*a.m21)/b;c.m02=(a.m01*a.m12-a.m02*a.m11)/b;c.m10=-(-a.m20*a.m12+a.m10*a.m22)/b;c.m11=(-a.m20*a.m02+a.m00*a.m22)/b;c.m12=-(-a.m10*a.m02+a.m00*a.m12)/b;c.m20=(-a.m20*a.m11+a.m10*a.m21)/b;c.m21=-(-a.m20*a.m01+a.m00*a.m21)/b;c.m22=(-a.m10*a.m02+a.m00*a.m11)/b;return c};
Fabrik.M3.prototype.rotateRads=function(a,b){var c=new Fabrik.M3,d=Math.sin(b),e=Math.cos(b),f=1-e,h=a.x*a.y,g=a.y*a.z,k=a.x*a.z,l=a.x*d,r=a.y*d,d=a.z*d,m=a.x*a.x*f+e,n=h*f+d,p=k*f-r,h=h*f-d,d=a.y*a.y*f+e,q=g*f+l,k=k*f+r,g=g*f-l,e=a.z*a.z*f+e,f=this.m00*m+this.m10*n+this.m20*p,l=this.m01*m+this.m11*n+this.m21*p,m=this.m02*m+this.m12*n+this.m22*p,n=this.m00*h+this.m10*d+this.m20*q,p=this.m01*h+this.m11*d+this.m21*q,h=this.m02*h+this.m12*d+this.m22*q;c.m20=this.m00*k+this.m10*g+this.m20*e;c.m21=this.m01*
k+this.m11*g+this.m21*e;c.m22=this.m02*k+this.m12*g+this.m22*e;c.m00=f;c.m01=l;c.m02=m;c.m10=n;c.m11=p;c.m12=h;return c};Fabrik.M3.prototype.rotateDegs=function(a,b){return this.rotateRads(b,a*Fabrik.torad)};Fabrik.M3.prototype.setXBasis=function(a){this.m00=a.x;this.m01=a.y;this.m02=a.z};Fabrik.M3.prototype.getXBasis=function(){return new Fabrik.V3(this.m00,this.m01,this.m02)};Fabrik.M3.prototype.setYBasis=function(a){this.m10=a.x;this.m11=a.y;this.m12=a.z};
Fabrik.M3.prototype.getYBasis=function(){return new Fabrik.V3(this.m10,this.m11,this.m12)};Fabrik.M3.prototype.setZBasis=function(a){this.m20=a.x;this.m21=a.y;this.m22=a.z};Fabrik.M3.prototype.getZBasis=function(){return new Fabrik.V3(this.m20,this.m21,this.m22)};
Fabrik.createRotationMatrix=function(a){var b,c=a.normalize();if(-0.9999999>a.z)a=new Fabrik.V3(1,0,0),b=new Fabrik.V3(0,1,0);else{b=1/(1+c.z);var d=-c.x*c.y*b;a=(new Fabrik.V3(1-c.x*c.x*b,d,-c.x)).normalize();b=(new Fabrik.V3(d,1-c.y*c.y*b,-c.y)).normalize()}d=new Fabrik.M3;d.setV3(a,b,c);return d};Fabrik.Joint=function(a){this.mHingeAnticlockwiseConstraintDegs=this.mHingeClockwiseConstraintDegs=this.mRotorConstraintDegs=Fabrik.MAX_ANGLE_DEGS;this.mRotationAxisUV=new Fabrik.V3;this.mReferenceAxisUV=new Fabrik.V3;this.type=Fabrik.J_BALL;void 0!==a&&(this.mRotorConstraintDegs=a.mRotorConstraintDegs,this.mHingeClockwiseConstraintDegs=a.mHingeClockwiseConstraintDegs,this.mHingeAnticlockwiseConstraintDegs=a.mHingeAnticlockwiseConstraintDegs,this.type=a.type,this.mRotationAxisUV.copy(a.mRotationAxisUV),
this.mReferenceAxisUV.copy(a.mReferenceAxisUV))};
Fabrik.Joint.prototype={constructor:Fabrik.Joint,clone:function(){return new Fabrik.Joint(this)},setAsBallJoint:function(a){this.mRotorConstraintDegs=a;this.type=Fabrik.J_BALL},setHinge:function(a,b,c,d,e){this.mHingeClockwiseConstraintDegs=c;this.mHingeAnticlockwiseConstraintDegs=d;this.type=a;this.mRotationAxisUV.copy(b.normalised());this.mReferenceAxisUV.copy(e.normalised())},getJointType:function(){return this.type},getHingeClockwiseConstraintDegs:function(){if(this.type!==Fabrik.J_BALL)return this.mHingeClockwiseConstraintDegs},
getHingeAnticlockwiseConstraintDegs:function(){if(this.type!==Fabrik.J_BALL)return this.mHingeAnticlockwiseConstraintDegs},getHingeReferenceAxis:function(){if(this.type!==Fabrik.J_BALL)return this.mReferenceAxisUV},getHingeRotationAxis:function(){if(this.type!==Fabrik.J_BALL)return this.mRotationAxisUV},getBallJointConstraintDegs:function(){if(this.type===Fabrik.J_BALL)return this.mRotorConstraintDegs},setAsGlobalHinge:function(a,b,c,d){this.setHinge(Fabrik.J_GLOBAL_HINGE,a,b,c,d)},setAsLocalHinge:function(a,
b,c,d){this.setHinge(Fabrik.J_LOCAL_HINGE,a,b,c,d)},setBallJointConstraintDegs:function(a){this.type===Fabrik.J_BALL&&(this.mRotorConstraintDegs=a)},setHingeJointClockwiseConstraintDegs:function(a){this.type!==Fabrik.J_BALL&&(this.mHingeClockwiseConstraintDegs=a)},setHingeJointAnticlockwiseConstraintDegs:function(a){this.type!==Fabrik.J_BALL&&(this.mHingeAnticlockwiseConstraintDegs=a)},setHingeRotationAxis:function(a){this.type!==Fabrik.J_BALL&&this.mRotationAxisUV.copy(a.normalised())},setHingeReferenceAxis:function(a){this.type!==
Fabrik.J_BALL&&this.mReferenceAxisUV.copy(a.normalised())}};Fabrik.Bone=function(a,b,c,d){this.mJoint=new Fabrik.Joint;this.mStartLocation=new Fabrik.V3;this.mEndLocation=new Fabrik.V3;this.mBoneConnectionPoint=Fabrik.END;this.mLength=0;this.init(a,b,c,d)};
Fabrik.Bone.prototype={constructor:Fabrik.Bone,init:function(a,b,c,d){this.setStartLocation(a);void 0!==b?(this.setEndLocation(b),this.setLength(Fabrik.distanceBetween(this.mStartLocation,this.mEndLocation))):(this.setLength(d),this.setEndLocation(this.mStartLocation.plus(c.normalised().times(d))))},clone:function(){var a=new Fabrik.Bone(this.mStartLocation,this.mEndLocation);a.mJoint=this.mJoint.clone();return a},length:function(){return this.mLength},liveLength:function(){return Fabrik.distanceBetween(this.mStartLocation,
this.mEndLocation)},setBoneConnectionPoint:function(a){this.mBoneConnectionPoint=a},setHingeJointClockwiseConstraintDegs:function(a){this.mJoint.setHingeJointClockwiseConstraintDegs(a)},setHingeJointAnticlockwiseConstraintDegs:function(a){this.mJoint.setHingeJointAnticlockwiseConstraintDegs(a)},setBallJointConstraintDegs:function(a){0>a&&(a=0);180<a&&(a=180);this.mJoint.setBallJointConstraintDegs(a)},setStartLocation:function(a){this.mStartLocation.copy(a)},setEndLocation:function(a){this.mEndLocation.copy(a)},
setLength:function(a){0<a&&(this.mLength=a)},setJoint:function(a){this.mJoint=a},getHingeJointClockwiseConstraintDegs:function(){return this.mJoint.getHingeClockwiseConstraintDegs()},getHingeJointAnticlockwiseConstraintDegs:function(){return this.mJoint.getHingeAnticlockwiseConstraintDegs()},getBallJointConstraintDegs:function(){return this.mJoint.getBallJointConstraintDegs()},getBoneConnectionPoint:function(){return this.mBoneConnectionPoint},getDirectionUV:function(){return Fabrik.getDirectionUV(this.mStartLocation,
this.mEndLocation)},getStartLocation:function(){return this.mStartLocation},getEndLocation:function(){return this.mEndLocation},getJointType:function(){return this.mJoint.getJointType()},getLength:function(){return this.mLength},getJoint:function(){return this.mJoint}};Fabrik.Chain=function(a){this.mChain=[];this.name="";this.mSolveDistanceThreshold=0.1;this.mMaxIterationAttempts=20;this.mMinIterationChange=0.01;this.mNumBones=this.mChainLength=0;this.mFixedBaseLocation=new Fabrik.V3;this.mFixedBaseMode=!0;this.mBaseboneConstraintType=Fabrik.BB_NONE;this.mBaseboneConstraintUV=new Fabrik.V3;this.mBaseboneRelativeConstraintUV=new Fabrik.V3;this.mBaseboneRelativeReferenceConstraintUV=new Fabrik.V3;this.mLastTargetLocation=new Fabrik.V3(Fabrik.MAX_VALUE,Fabrik.MAX_VALUE,
Fabrik.MAX_VALUE);this.mLastBaseLocation=new Fabrik.V3(Fabrik.MAX_VALUE,Fabrik.MAX_VALUE,Fabrik.MAX_VALUE);this.mCurrentSolveDistance=Fabrik.MAX_VALUE;this.mConnectedBoneNumber=this.mConnectedChainNumber=-1;void 0!==a&&(this.mChain=a.cloneIkChain(),this.mFixedBaseLocation.copy(a.mFixedBaseLocation),this.mLastTargetLocation.copy(a.mLastTargetLocation),this.mLastBaseLocation.copy(a.mLastBaseLocation),a.mBaseboneConstraintType!==Fabrik.BB_NONE&&(this.mBaseboneConstraintUV.copy(a.mBaseboneConstraintUV),
this.mBaseboneRelativeConstraintUV.copy(a.mBaseboneRelativeConstraintUV)),this.mChainLength=a.mChainLength,this.mNumBones=a.mNumBones,this.mCurrentSolveDistance=a.mCurrentSolveDistance,this.mConnectedChainNumber=a.mConnectedChainNumber,this.mConnectedBoneNumber=a.mConnectedBoneNumber,this.mBaseboneConstraintType=a.mBaseboneConstraintType,this.name=a.name)};
Fabrik.Chain.prototype={constructor:Fabrik.Chain,clear:function(){for(var a=this.mNumBones;a--;)this.removeBone(a)},addBone:function(a){this.mChain.push(a);0===this.mNumBones&&(this.mFixedBaseLocation.copy(a.getStartLocation()),this.mBaseboneConstraintUV.copy(a.getDirectionUV()));this.mNumBones++;this.updateChainLength()},removeBone:function(a){a<this.mNumBones&&(this.mChain.splice(a,1),this.mNumBones--,this.updateChainLength())},addConsecutiveBone:function(a,b){if(0<this.mNumBones){var c=this.mChain[this.mNumBones-
1].getEndLocation();this.addBone(new Fabrik.Bone(c,void 0,a.normalised(),b))}},addConsecutiveFreelyRotatingHingedBone:function(a,b,c,d){this.addConsecutiveHingedBone(a,b,c,d,180,180,Fabrik.genPerpendicularVectorQuick(d))},addConsecutiveHingedBone:function(a,b,c,d,e,f,h){if(0!==this.mNumBones){a.normalize();d.normalize();var g=this.mChain[this.mNumBones-1].getEndLocation();a=new Fabrik.Bone(g,a,b);b=new Fabrik.Joint;switch(c){case Fabrik.J_GLOBAL_HINGE:b.setAsGlobalHinge(d,e,f,h);break;case Fabrik.J_LOCAL_HINGE:b.setAsLocalHinge(d,
e,f,h)}a.setJoint(b);this.addBone(a)}},addConsecutiveRotorConstrainedBone:function(a,b,c){0!==this.mNumBones&&(a=new Fabrik.Bone(this.mChain[this.mNumBones-1].getEndLocation(),a.normalize(),b),a.setBallJointConstraintDegs(c),this.addBone(a))},getBaseboneConstraintType:function(){return this.mBaseboneConstraintType},getBaseboneConstraintUV:function(){if(this.mBaseboneConstraintType!==Fabrik.BB_NONE)return this.mBaseboneConstraintUV},getBaseLocation:function(){return this.mChain[0].getStartLocation()},
getBone:function(a){return this.mChain[a]},getChain:function(){return this.mChain},getChainLength:function(){return this.mChainLength},getConnectedBoneNumber:function(){return this.mConnectedBoneNumber},getConnectedChainNumber:function(){return this.mConnectedChainNumber},getEffectorLocation:function(){return this.mChain[this.mNumBones-1].getEndLocation()},getLastTargetLocation:function(){return this.mLastTargetLocation},getLiveChainLength:function(){for(var a=0,b=0;b<this.mNumBones;b++)a+=this.mChain[b].liveLength();
return a},getName:function(){return this.name},getNumBones:function(){return this.mNumBones},getBaseboneRelativeReferenceConstraintUV:function(){return this.mBaseboneRelativeReferenceConstraintUV},setBaseboneRelativeConstraintUV:function(a){this.mBaseboneRelativeConstraintUV=a},setBaseboneRelativeReferenceConstraintUV:function(a){this.mBaseboneRelativeReferenceConstraintUV=a},setRotorBaseboneConstraint:function(a,b,c){0!==this.mNumBones&&0<b.length()&&(0>c&&(c=0),180<c&&(c=180),a===Fabrik.BB_GLOBAL_ROTOR&&
a===Fabrik.BB_LOCAL_ROTOR&&(this.mBaseboneConstraintType=a,this.mBaseboneConstraintUV=b.normalised(),this.mBaseboneRelativeConstraintUV.copy(this.mBaseboneConstraintUV),this.getBone(0).getJoint().setAsBallJoint(c)))},setHingeBaseboneConstraint:function(a,b,c,d,e){if(0!==this.mNumBones&&0<b.length()&&0<e.length()&&Fabrik.perpendicular(b,e)&&a===Fabrik.BB_GLOBAL_HINGE&&a===Fabrik.BB_LOCAL_HINGE){this.mBaseboneConstraintType=a;this.mBaseboneConstraintUV.copy(b.normalised());var f=new Fabrik.Joint;a===
Fabrik.BB_GLOBAL_HINGE?f.setHinge(Fabrik.J_GLOBAL_HINGE,b,c,d,e):f.setHinge(Fabrik.J_LOCAL_HINGE,b,c,d,e);this.getBone(0).setJoint(f)}},setFreelyRotatingGlobalHingedBasebone:function(a){this.setHingeBaseboneConstraint(Fabrik.BB_GLOBAL_HINGE,a,180,180,Fabrik.genPerpendicularVectorQuick(a))},setFreelyRotatingLocalHingedBasebone:function(a){this.setHingeBaseboneConstraint(Fabrik.BB_LOCAL_HINGE,a,180,180,Fabrik.genPerpendicularVectorQuick(a))},setLocalHingedBasebone:function(a,b,c,d){this.setHingeBaseboneConstraint(Fabrik.BB_LOCAL_HINGE,
a,b,c,d)},setGlobalHingedBasebone:function(a,b,c,d){this.setHingeBaseboneConstraint(Fabrik.BB_GLOBAL_HINGE,a,b,c,d)},setBaseboneConstraintUV:function(a){this.mBaseboneConstraintType!==Fabrik.BB_NONE&&(this.constraintUV.normalize(),this.mBaseboneConstraintUV.copy(a))},setBaseLocation:function(a){this.mFixedBaseLocation.copy(a)},setChain:function(a){this.mChain=a},connectToStructure:function(a,b,c){var d=a.getNumChains();b>d||(a=a.getChain(b).getNumBones(),c>a||(this.mConnectedChainNumber=b,this.mConnectedBoneNumber=
c))},setFixedBaseMode:function(a){if(a||-1===this.mConnectedChainNumber)if(this.mBaseboneConstraintType!=Fabrik.BB_GLOBAL_ROTOR||a)this.mFixedBaseMode=a},setMaxIterationAttempts:function(a){1>a||(this.mMaxIterationAttempts=a)},setMinIterationChange:function(a){0>a||(this.mMinIterationChange=a)},setSolveDistanceThreshold:function(a){0>a||(this.mSolveDistanceThreshold=a)},updateTarget:function(a){a=new Fabrik.V3(a.x,a.y,a.z);if(this.mLastTargetLocation.approximatelyEquals(a,0.001)&&this.mLastBaseLocation.approximatelyEquals(this.getBaseLocation(),
0.001))return this.mCurrentSolveDistance;for(var b=[],c=Fabrik.MAX_VALUE,d=Fabrik.MAX_VALUE,e,f=0;f<this.mMaxIterationAttempts;f++){e=this.solveIK(a);if(e<c){if(c=e,b=this.cloneIkChain(),e<this.mSolveDistanceThreshold)break}else if(Math.abs(e-d)<this.mMinIterationChange)break;d=e}this.mCurrentSolveDistance=c;this.mChain=b;this.mLastBaseLocation.copy(this.getBaseLocation());this.mLastTargetLocation.copy(a);return this.mCurrentSolveDistance},solveIK:function(a){var b;if(0!==this.mNumBones){for(b=this.mNumBones-
1;0<=b;b--){var c=this.mChain[b],d=c.getLength(),e=c.getJoint(),f=c.getJointType();if(b!=this.mNumBones-1){var h=this.mChain[b+1].getDirectionUV().negated(),g=c.getDirectionUV().negated();if(f===Fabrik.J_BALL)f=Fabrik.getAngleBetweenDegs(h,g),e=e.getBallJointConstraintDegs(),f>e&&(g=Fabrik.getAngleLimitedUnitVectorDegs(g,h,e));else if(f===Fabrik.J_GLOBAL_HINGE)g=g.projectOnPlane(e.getHingeRotationAxis());else if(f===Fabrik.J_LOCAL_HINGE){var k,l;0<b?(k=Fabrik.createRotationMatrix(this.mChain[b-1].getDirectionUV()),
l=k.timesV3(e.getHingeRotationAxis()).normalize()):l=this.mBaseboneRelativeConstraintUV;g=g.projectOnPlane(l)}d=c.getEndLocation().plus(g.times(d))}else{c.setEndLocation(a);g=c.getDirectionUV().negated();switch(f){case Fabrik.J_GLOBAL_HINGE:g=g.projectOnPlane(e.getHingeRotationAxis());break;case Fabrik.J_LOCAL_HINGE:k=Fabrik.createRotationMatrix(this.mChain[b-1].getDirectionUV()),l=k.timesV3(e.getHingeRotationAxis()).normalize(),g=g.projectOnPlane(l)}d=a.plus(g.times(d))}c.setStartLocation(d);0<b&&
this.mChain[b-1].setEndLocation(d)}for(b=0;b<this.mNumBones;b++)c=this.mChain[b],d=c.getLength(),0!=b?(g=c.getDirectionUV(),h=this.mChain[b-1].getDirectionUV(),e=c.getJoint(),f=e.getJointType(),f===Fabrik.J_BALL?(f=Fabrik.getAngleBetweenDegs(h,g),e=e.getBallJointConstraintDegs(),f>e&&(g=Fabrik.getAngleLimitedUnitVectorDegs(g,h,e))):f===Fabrik.J_GLOBAL_HINGE?(l=e.getHingeRotationAxis(),g=g.projectOnPlane(l),f=-e.getHingeClockwiseConstraintDegs(),h=e.getHingeAnticlockwiseConstraintDegs(),Fabrik.nearEquals(f,
-Fabrik.MAX_ANGLE_DEGS,0.001)||Fabrik.nearEquals(h,Fabrik.MAX_ANGLE_DEGS,0.001)||(k=e.getHingeReferenceAxis(),e=Fabrik.getSignedAngleBetweenDegs(k,g,l),e>h?g=Fabrik.rotateAboutAxisDegs(k,h,l).normalised():e<f&&(g=Fabrik.rotateAboutAxisDegs(k,f,l).normalised()))):f===Fabrik.J_LOCAL_HINGE&&(l=e.getHingeRotationAxis(),k=Fabrik.createRotationMatrix(h),l=k.timesV3(l).normalize(),g=g.projectOnPlane(l),f=-e.getHingeClockwiseConstraintDegs(),h=e.getHingeAnticlockwiseConstraintDegs(),Fabrik.nearEquals(f,-Fabrik.MAX_ANGLE_DEGS,
0.001)||Fabrik.nearEquals(h,Fabrik.MAX_ANGLE_DEGS,0.001)||(k=k.timesV3(e.getHingeReferenceAxis()).normalize(),e=Fabrik.getSignedAngleBetweenDegs(k,g,l),e>h?g=Fabrik.rotateAboutAxisDegs(k,h,l).normalize():e<f&&(g=Fabrik.rotateAboutAxisDegs(k,f,l).normalize()))),d=c.getStartLocation().plus(g.times(d)),c.setEndLocation(d),b<this.mNumBones-1&&this.mChain[b+1].setStartLocation(d)):(this.mFixedBaseMode?c.setStartLocation(this.mFixedBaseLocation):c.setStartLocation(c.getEndLocation().minus(c.getDirectionUV().times(d))),
this.mBaseboneConstraintType===Fabrik.BB_NONE?(d=c.getStartLocation().plus(c.getDirectionUV().times(d)),c.setEndLocation(d),1<this.mNumBones&&this.mChain[1].setStartLocation(d)):this.mBaseboneConstraintType===Fabrik.BB_GLOBAL_ROTOR?(g=c.getDirectionUV(),f=Fabrik.getAngleBetweenDegs(this.mBaseboneConstraintUV,g),e=c.getBallJointConstraintDegs(),f>e&&(g=Fabrik.getAngleLimitedUnitVectorDegs(g,this.mBaseboneConstraintUV,e)),d=c.getStartLocation().plus(g.times(d)),c.setEndLocation(d),1<this.mNumBones&&
this.mChain[1].setStartLocation(d)):this.mBaseboneConstraintType===Fabrik.BB_LOCAL_ROTOR?(g=c.getDirectionUV(),f=Fabrik.getAngleBetweenDegs(this.mBaseboneRelativeConstraintUV,g),e=c.getBallJointConstraintDegs(),f>e&&(g=Fabrik.getAngleLimitedUnitVectorDegs(g,this.mBaseboneRelativeConstraintUV,e)),d=c.getStartLocation().plus(g.times(d)),c.setEndLocation(d),1<this.mNumBones&&this.mChain[1].setStartLocation(d)):this.mBaseboneConstraintType===Fabrik.BB_GLOBAL_HINGE?(e=c.getJoint(),l=e.getHingeRotationAxis(),
f=-e.getHingeClockwiseConstraintDegs(),h=e.getHingeAnticlockwiseConstraintDegs(),g=c.getDirectionUV().projectOnPlane(l),Fabrik.nearEquals(f,Fabrik.MAX_ANGLE_DEGS,0.01)||Fabrik.nearEquals(h,Fabrik.MAX_ANGLE_DEGS,0.01)||(k=e.getHingeReferenceAxis(),e=Fabrik.getSignedAngleBetweenDegs(k,g,l),e>h?g=Fabrik.rotateAboutAxisDegs(k,h,l).normalize():e<f&&(g=Fabrik.rotateAboutAxisDegs(k,f,l).normalize())),d=c.getStartLocation().plus(g.times(d)),c.setEndLocation(d),1<this.mNumBones&&this.mChain[1].setStartLocation(d)):
this.mBaseboneConstraintType===Fabrik.BB_LOCAL_HINGE&&(e=c.getJoint(),l=this.mBaseboneRelativeConstraintUV,f=-e.getHingeClockwiseConstraintDegs(),h=e.getHingeAnticlockwiseConstraintDegs(),g=c.getDirectionUV().projectOnPlane(l),Fabrik.nearEquals(f,Fabrik.MAX_ANGLE_DEGS,0.01)||Fabrik.nearEquals(h,Fabrik.MAX_ANGLE_DEGS,0.01)||(k=this.mBaseboneRelativeReferenceConstraintUV,e=Fabrik.getSignedAngleBetweenDegs(k,g,l),e>h?g=Fabrik.rotateAboutAxisDegs(k,h,l).normalize():e<f&&(g=Fabrik.rotateAboutAxisDegs(k,
f,l).normalize())),d=c.getStartLocation().plus(g.times(d)),c.setEndLocation(d),1<this.mNumBones&&this.mChain[1].setStartLocation(d)));this.mLastTargetLocation.copy(a);return Fabrik.distanceBetween(this.mChain[this.mNumBones-1].getEndLocation(),a)}},updateChainLength:function(){for(var a=this.mChainLength=0;a<this.mNumBones;a++)this.mChainLength+=this.mChain[a].getLength()},cloneIkChain:function(){for(var a=this.mChain.length,b=[],c=0;c<a;c++)b.push(this.mChain[c].clone());return b}};Fabrik.Structure=function(){this.mChains=[];this.meshChains=[];this.targets=[];this.mNumChains=0};
Fabrik.Structure.prototype={constructor:Fabrik.Structure,update:function(){for(var a,b,c,d=0;d<this.mNumChains;d++){a=this.mChains[d];b=this.meshChains[d];a.updateTarget(this.targets[d]);for(var e=0;e<a.mNumBones;e++)c=a.getBone(e),b[e].position.copy(c.getStartLocation()),b[e].lookAt(c.getEndLocation())}},clear:function(){for(var a=this.mNumChains;a--;)this.remove(a)},add:function(a,b,c){this.mChains.push(a);b&&this.meshChains.push(b);this.targets.push(c);this.mNumChains++},remove:function(a){this.mChains[a].clear();
this.mChains.splice(a,1);this.meshChains.splice(a,1);this.targets.splice(a,1);this.mNumChains--},setFixedBaseMode:function(a){for(var b=0;b<this.mNumChains;b++)this.mChains[b].setFixedBaseMode(a)},getChain:function(a){return this.mChains[a]},connectChain:function(a,b,c,d){if(!(b>this.mNumChains||c>this.mChains[b].getNumBones())){a=new Fabrik.Chain(a);a.connectToStructure(this,b,c);b=(d||this.getChain(b).getBone(c).getBoneConnectionPoint())===Fabrik.START?this.mChains[b].getBone(c).getStartLocation():
this.mChains[b].getBone(c).getEndLocation();a.setBaseLocation(b);a.setFixedBaseMode(!0);for(c=0;c<a.getNumBones();c++){var e=a.getBone(c).getStartLocation();d=a.getBone(c).getEndLocation();e=e.plus(b);d=d.plus(b);a.getBone(c).setStartLocation(e);a.getBone(c).setEndLocation(d)}this.addChain(a)}}};
